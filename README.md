# Sparkify Data Lake Project

The music stream start-up Sparkify has significantly expanded their user base 
and their song base, and are logging substantially more traffic. 
Their data current sits on AWS S3 in JSON files, and want to set up a data lake
to facilitate data exploration and analysis by business users. 
In this project, we deliver a service which meets these needs. 

To summarise the steps taken, we:
	- pull data from AWS S3 storage using an ETL pipeline
	- process the data using Spark to create analytics tables
	- load the tables back to S3 
	
To complete the ETL steps and create the tables, we use a Spark cluster on an
AWS EMR notebook. 

## Datasets

Sparkify has two datasets:
	The first dataset is a subset of real data from the Million Song Dataset. 
	Each file is in JSON format and contains metadata about a song and the 
	artist of that song. 
	The files are partitioned by the first three letters of each song's track 
	ID. 
	For example, here are filepaths to two files in this dataset.

	song_data/A/B/C/TRABCEI128F424C983.json
	song_data/A/A/B/TRAABJL12903CDCF1A.json
	
	
	The second dataset consists of log files in JSON format generated by this 
	event simulator based on the songs in the dataset above. 
	These simulate app activity logs from an imaginary music streaming app 
	based on configuration settings.
	The log files in the dataset you'll be working with are partitioned by year
	and month. 
	For example, here are filepaths to two files in this dataset.

	log_data/2018/11/2018-11-12-events.json
	log_data/2018/11/2018-11-13-events.json


## Analytics tables/Schema

This project delivers five analytics tables for further data study. 
We include one fact table and four dimension tables. 
These tables are as follows:

	- Fact table    
		- songplays - records in log data associated with song plays i.e. 
		records with the page NextSong. 
		Columns: 
        songplay_id, start_time, user_id, level, song_id, artist_id, 
		session_id, location, user_agent


	- Dimension tables
		- users - table of users of the app. 
		Columns: 
		user_id, first_name, last_name, gender, level
		- songs - table of songs in music database. 
		Columns:
		song_id, title, artist_id, year, duration
		- artists - table of artists in music database. 
		Columns: 
		artist_id, name, location, lattitude, longitude
		- time - table of timestamps of records in songplays, broken down into 
		specific units
		Colmns: 
		start_time, hour, day, week, month, year, weekday

## Project files

This project contains three files:
    etl.py - reads data from S3, processes that data using Spark, and writes 
	them back to S3
	sparkify.ipynb - iPython notebook completing the same tasks as the etl.py file
    dl.cfg - contains the AWS credentials (redacted in this version)
    README.md - this file - provides discussion on project motivation, 
	processes, and requirements
	
At the bottom of this file we include some query examples to demonstrate 
functionality. 
	
## Execution

To run the files in this project, we create an AWS EMR cluster with the 
following configuration details:
	- Release label: emr-6.10.0
	- Hadoop distribution: Amazon 3.3.3
	- Applications: JupyterHub 1.5.0, Hive 3.1.3, Pig 0.17.0, Hue 4.10.0, 
	JupyterEnterpriseGateway 2.6.0, Spark 3.3.1, Livy 0.7.1
	- AWS Region: us-west-1 (N. California)
	- Master EC2: 1x m3.xlarge
	- Core EC2s: 2x m3.xlarge
	
To implement this set-up, we use a default VPC in this Region, and include the
default EC2 instance profiles and EMR roles. 

We run the etl.py/etl.ipynb in an EMR cluster notebook. 
With this set-up, execution time on the full dataset takes around "X" minutes,     16:25 start
with "Y" normalised instance hours. 

## Query examples

We query our tables using Spark SQL in the same notebook as the Spark Session. 

spark.sql('''SELECT * 
			 FROM artists 
			 LIMIT 10''').show()


+------------------+--------------------+--------------------+---------+---------+
|         artist_id|                name|            location| latitude|longitude|
+------------------+--------------------+--------------------+---------+---------+
|AROU8WM1187B9B4620|   Milton Nascimento|Rio de Janeiro, B...|-22.97673|-43.19508|
|ARWLT1T1187B99B4CC|         Grant Green|       St. Louis, MO| 38.62774|-90.19951|
|ARKGYG81187FB579A8|       Lucy Woodward|      Los Angeles CA| 40.71455|-74.00712|
|AR5EH4F1187B98FC65|Berlin Symphony O...|                    |     null|     null|
|ARSMEBG1187FB4D02B|         Kevin Ayers|Herne Bay, Kent, ...| 51.37121|   1.1251|
|ARDIJLO1187FB3CE44|         Sandie Shaw|Dagenham, Essex, ...|     null|     null|
|ARD0FN11187B9B25CD|         Bobby Darin|New York, NY [The...| 40.85715|-73.85678|
|ARRL7WS1187FB576F1|  Ferrante & Teicher|                    |     null|     null|
|ARCII0J1187FB3A1B4|   The Marx Brothers|New York City, Ne...| 40.71455|-74.00712|
|ARUONH81187FB4FBB4|    ClickClickDecker|                    |     null|     null|
+------------------+--------------------+--------------------+---------+---------+